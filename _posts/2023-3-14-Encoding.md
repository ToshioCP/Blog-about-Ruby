---
layout: posts
title: Encoding
description: Encoding
category: 基本事項
date: 2023-3-14 13:00:00 +0900
---

文字列のエンコーディングに頭を悩ませることはほとんどなくなりました。
なぜなら、どのアプリ、システムもUTF-8を使うようになったからです。
Rubyでもエンコーディングの問題が起こることはまず無いでしょう。
ですが、今回はエンコーディングの考え方を整理してみたいと思います。

- [ASCIIコード](#asciiコード)
- [ASCII 以外のコード](#ascii-以外のコード)
- [スクリプトエンコーディングとリテラルのエンコーディング](#スクリプトエンコーディングとリテラルのエンコーディング)
- [文字列のエンコーディング](#文字列のエンコーディング)
- [I/Oのエンコーディング](#ioのエンコーディング)
  - [テキストの読み込み](#テキストの読み込み)
  - [テキストの書き込み](#テキストの書き込み)
  - [標準入出力](#標準入出力)


## ASCIIコード

コンピュータの内部では文字を数字に置き換えて記憶しています。
これを文字コードといいます。
初期の有名な文字コードにASCII（アスキー）がありますが、これは7ビットで表すことができます。
ビットとは、メモリーの最小単位で、1と0を区別できるものです。
8個のビットをバイトといい、コンピュータはバイト単位でメモリーを扱います。
1ビットは0と1を表すことができますが、1バイトだと\\(2^8=256\\)個を区別でき、数字としては0から255までを区別できるようになります。
ASCIIは7ビットなので、0から\\(2^7-1=127\\)までの数字が文字に対応します。

<https://ja.wikipedia.org/wiki/ASCII>

例えば大文字のAは16進数の41（10進数の65）小文字のaは16進数の61（10進数の97）などです。
詳しくは上記のリンク先を参照してください。
ASCIIで表せるのは大文字と小文字のアルファベット、ピリオドなどの記号、改行などを表すコントロールコードだけです。
要するに、キーボードで直接入力できる文字だと思えば良いでしょう。

ASCIIは7ビットですが、コンピュータはバイト単位にデータを処理するので、ASCIIも8ビットで処理されることが普通です。
このとき、最上位ビットは0になります。
もしも最上位ビットが1だと、ASCIIの定義外なので、文字としては不定ということになります。
Rubyではこのような1バイト単位で、0から127まではASCIIとして扱うことができるコード体系（エンコード）を`ASCII_8BIT`としています。
主にバイナリデータを扱うのに使われます。

## ASCII 以外のコード

日本語にはアルファベット以外に、ひらがな、カタカナ、漢字があります。
他の言語でも、例えばドイツ語ではウムラウトやエスツェット（ß）があります。
これらをASCIIで表すことはできません。
そのため、2バイト以上を使って様々な文字と数字（文字コード）を対応させるということが考えられました。
この方法が現在ではUTF-8でほぼ統一されていますが、過去にはSHIFT-JISやEUC-JPなどがありました。
それらをエンコーディングといいます。
つまり、エンコーディングは文字と数字（文字コード）の対応を表すルールなのです。

しかし、UTF-8、SHIFT-JIS、EUC-JPには互換性がありませんので、あるコード体系から別のコード体系には「変換」が必要です。
過去にはWindowsはSHIFT-JISが使われLinuxではEUC-JPが使われていましたので、両者でデータのやりとりをするときには文字コードの変換が必要でした。
また、これらのコードは日本語以外の言語（ASCII以外）の文字サポートがありませんでした。
最終的にはUnicodeという様々な国の言語の文字をサポートするコード体系が生まれ、特にUTF-8が標準的に用いられるようになりました。
現在ではWIndowsもLinuxもMacもUTF-8が標準です。

このようにしてUTF-8がどのシステムでも使われるようになったので、問題は起こらなくなりました。
これらの文字コードのことをエンコーディングといいます。
Rubyでは文字列にエンコーディングが付随していて、UTF-8以外にEUC-JPやSHIFT-JISにも対応できるようになっています。

以下ではRubyでエンコーディングが問題になることがらについて説明します。

## スクリプトエンコーディングとリテラルのエンコーディング

Rubyで書いているプログラム自体の文字コードはどのような問題を含むでしょうか？
これは「スクリプトエンコーディング」の問題と呼びます。

Rubyのキーワードは、すべてASCIIの範囲にあり、その限りではRubyは正しくスクリプトを解釈してくれます。
UTF-8、SHIFT-JIS、EUC-JPなどは、すべてASCIIの範囲の文字はそのとおりにコードになっています。
例えば「def」の文字コードは16進数で「64 65 66」で、これは上記の3つの文字コードでも同じです。
このようにASCIIの範囲の文字はASCIIと同じコードを使うエンコーディングをASCII互換エンコーディングといいます。
それ以外のエンコーディングはASCII非互換エンコーディングです。

RubyスクリプトにはASCII互換エンコーディング（Rubyがサポートしている）を使うことができます。
逆にそれ以外、ASCII非互換やRubyがサポートしないエンコーディングは使うことができません。

また、スクリプトのエンコーディングを明示的に指定したいときはマジックコメントを使います。
詳しくはRubyのドキュメントの[多言語化](https://docs.ruby-lang.org/ja/3.1/doc/spec=2fm17n.html)を参照してください。

文字列リテラル、正規表現リテラル、シンボルリテラルには文字列が出てくるので、エンコーディングが関わります。
これらはスクリプトエンコーディングに従います。
ただしバックスラッシュ記法で文字コードを表す場合は他の文字コードに変換されたり、エラーになることがあります。
詳細は[多言語化](https://docs.ruby-lang.org/ja/3.1/doc/spec=2fm17n.html)を参照してください。
通常はリテラルのエンコーディングはスクリプトエンコーディングだと考えれば大丈夫です。

## 文字列のエンコーディング

Rubyの文字列オブジェクトはエンコーディングを持っていて、encodingメソッドでその文字列のエンコーディングを知ることができます。

```ruby
p s.encoding #=>#<Encoding:UTF-8>
```

- ある文字列を他のエンコーディングの同じ文字列に変更するにはencodeメソッドを使います。
- ある文字列をその文字列の内容を変えずにエンコーディングを変更するにはforce\_encodingメソッドを使います。

この2つは混乱しやすいので注意してください。
encodeメソッドはエンコーディングを変えるだけでなく、文字列の内容（コード）も変更されますが、force\_encodingではエンコーディングのみが変更されます。


```ruby
s = "あ"
p s.encoding #=>#<Encoding:UTF-8>
t = s.encode(Encoding::EUC_JP)
p t.encoding #=>#<Encoding:EUC-JP>
p s.force_encoding(Encoding::ASCII_8BIT)
p t.force_encoding(Encoding::ASCII_8BIT)
```

これを実行すると

```
#<Encoding:UTF-8>
#<Encoding:EUC-JP>
"\xE3\x81\x82"
"\xA4\xA2"
```

となります。
後半2行から、sとtでは文字コードが変更されていることが分かります。
異なるコードですが、表している文字は両方とも「あ」です。

文字列を`==`で比較する場合、「等しい」と判定されるのは次の2条件を満たすときです。

- エンコーディングが等しい
- 文字列の内容（コード）が等しい

したがって、sとtは両方とも「あ」を表しているが、エンコーディングが異なるので、「`s==t`」はfalseになります。

このような問題は複数のエンコーディングを使っているところから発生するので、ひとつのエンコーディングだけならば、ことは単純になります。

## I/Oのエンコーディング

外部から入力するときに、それが文字列であればエンコーディングが問題になります。

### テキストの読み込み

テキスト読み込みメソッド、例えば`IO.readlines`はエンコーディングの影響を受けます。
読み込み元はRubyの外部ですから、Rubyがエンコーディングを決めることはできません。
プログラマーが外部のエンコーディングを把握して、Rubyに設定することになります。
このエンコーディングをIOの「外部エンコーディング」といいます。

Rubyの内部で使っているエンコーディングはデフォルトでUTF-8です（変更もできますが）。
これを「内部エンコーディング」といいます。
あるIOに対して「外部エンコーディング」と「内部エンコーディング」がわかっていれば、Rubyは読み込み時に変換してくれます。
これらのエンコーディングを指定するのが「set\_encoding」メソッドです。
その引数は、外部エンコーディング、内部エンコーディングの順に指定します。
エンコーディングには文字列またはエンコーディング定数（例えば`Encoding::UTF_8`）が使えます。

今、「こんにちは」という日本語テキストがEUC-JPで保存されたファイル「gr_euc.txt」があるとします。
これを読むこむときにUTF-8に変換するには次のようにします。

```ruby
f = File.open("gr_euc.txt", "r")
f.set_encoding("EUC-JP", "UTF-8")
print f.read #=> こんにちは
f.close
```

詳細は[IO のエンコーディングとエンコーディングの変換](https://docs.ruby-lang.org/ja/3.1/class/IO.html#io_encoding)を参照してください。

Ruby/gtk4を使う場合、RubyでなくGTK 4、より正確にはGIOの入力関数を使うことがあります。
そのとき、エンコーディングが考慮されていないので、Rubyとしてはバイナリ入力のASCII-8BITでエンコーディングを設定することがあります。
そのときには必要なエンコーディングをforce\_encodingメソッドで入力文字列に与えることが必要になります。

### テキストの書き込み

テキストの書き込みは読み込みよりも単純です。

- 外部エンコーディングが指定されている＝＞外部エンコーディングで出力される
- 外部エンコーディングがない＝＞そのまま出力される

```ruby
s = "あいうえお" # UTF-8
f = File.open("gr.txt", "w")
f.write(s) # UTF-8で出力
f.close

f = File.open("gr_euc.txt", "w")
f.set_encoding("EUC-JP")
f.write(s) # EUC-JPで出力
f.close

f = File.open("gr_sjis.txt", "w")
f.set_encoding("SJIS","UTF-8")
f.write(s) # Shift-JISで出力
f.close
```

### 標準入出力

ここでは、デフォルトの標準入出力である、キーボード入力と画面出力について扱います。
これらは、オペレーティング・システムによって、どのエンコーディングを使うかが決められます。
UBUNTUなどのLinuxオペレーティング・システムでは現在はほとんどUTF-8です。

ですから、Rubyスクリプトが他のエンコーディングの文字列を持っていて、それを画面出力するときにはUTF-8に変換しなければなりません。
この方法には2つあります。

- 文字列のエンコーディングをUTF-8に変換しておく。これはencodeメソッドでできます。
- $stdoutの外部エンコーディングはデフォルトでnilになっている（つまり出力時に何の変換もしない）。それをUTF-8に設定すると出力時に自動的に変換をしてくれる。

```ruby
$stdout.set_encoding(Encoding::UTF_8)
```
